<!DOCTYPE html>
<html>
  <head>
  <title>
      
          Php-fpm 2. Php Fpm 配置 - Mitirrli
      
  </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="" />
  <link rel="shortcut icon" type="image/x-icon" href="/img/">

  
  
  
  
  
  <link rel="stylesheet" href="https://mitirrli.github.io/blog/style.min.6f642c5866835106e8a19b94463576436c99be9e41a8714ab3df3daa95f6bf90.css" integrity="sha256-b2QsWGaDUQbooZuURjV2Q2yZvp5BqHFKs989qpX2v5A=">
  
  
  
  <link rel="stylesheet" href="https://mitirrli.github.io/blog/style-dark.min.0a647fb6c07e04b77b54fa0515d0a683d39ecdb251dba960fe1f966f7ff36fc2.css" media="(prefers-color-scheme: dark)" integrity="sha256-CmR/tsB&#43;BLd7VPoFFdCmg9OezbJR26lg/h&#43;Wb3/zb8I=">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

  
  

  <meta property="og:title" content="Php-fpm 2. Php Fpm 配置" />
<meta property="og:description" content="1. slow log 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  $ cd /tmp/php-8." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mitirrli.github.io/blog/php/php-fpm-conf/" />
<meta property="article:published_time" content="2020-10-07T21:55:24+08:00" />
<meta property="article:modified_time" content="2020-10-24T18:11:06+08:00" />
<meta itemprop="name" content="Php-fpm 2. Php Fpm 配置">
<meta itemprop="description" content="1. slow log 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  $ cd /tmp/php-8.">
<meta itemprop="datePublished" content="2020-10-07T21:55:24+08:00" />
<meta itemprop="dateModified" content="2020-10-24T18:11:06+08:00" />
<meta itemprop="wordCount" content="559">



<meta itemprop="keywords" content="php-fpm,php," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:image" content="https://mitirrli.github.io/blog//img/"/>
<meta name="twitter:title" content="Php-fpm 2. Php Fpm 配置"/>
<meta name="twitter:description" content="1. slow log 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  $ cd /tmp/php-8."/>

  <!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->

  <!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <![endif]-->

  </head>

  <body>
    
  <h1>Php-fpm 2. Php Fpm 配置</h1>
  <header>
  
  <div class="avatar">
    <img class="avatarMask" src="https://mitirrli.github.io/blog//img/" alt="">
    <a href="https://mitirrli.github.io/blog/"><img class="avatar-border" src="https://mitirrli.github.io/blog//img/avatar-border.svg" alt=""></a>
  </div>
  
  <h2><a class="author" href="https://mitirrli.github.io/blog/"></a></h2>
</header>

  
  
  
  <p class="date">October 7, 2020</p>
  
  
  
  <div id="tags">
    <ul>
      
        
        
          <li><a href="https://mitirrli.github.io/blog/tags/php-fpm/">php-fpm</a></li>
        
      
        
        
          <li><a href="https://mitirrli.github.io/blog/tags/php/">php</a></li>
        
      
    </ul>
  </div>
  
  
  <div id="contentBody">
    <h4 id="1-slow-log">1. slow log</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">cd</span> /tmp/php-8.0.0beta3/output <span class="o">&amp;&amp;</span> mkdir log <span class="o">&amp;&amp;</span> chown -R www-data:www-data log

<span class="c1"># 慢日志目录在 /tmp/php-8.0.0beta3/output/log</span>

$ vim /tmp/php-8.0.0beta3/output/etc/php-fpm.d/www.conf //打开慢日志开关

<span class="p">;</span> The log file <span class="k">for</span> slow requests
<span class="p">;</span> Default Value: not <span class="nb">set</span>
<span class="p">;</span> Note: slowlog is mandatory <span class="k">if</span> request_slowlog_timeout is <span class="nb">set</span>
<span class="nv">slowlog</span> <span class="o">=</span> log/<span class="nv">$pool</span>.log.slow

<span class="p">;</span> The timeout <span class="k">for</span> serving a single request after which a PHP backtrace will be
<span class="p">;</span> dumped to the <span class="s1">&#39;slowlog&#39;</span> file. A value of <span class="s1">&#39;0s&#39;</span> means <span class="s1">&#39;off&#39;</span>.
<span class="p">;</span> Available units: s<span class="o">(</span>econds<span class="o">)(</span>default<span class="o">)</span>, m<span class="o">(</span>inutes<span class="o">)</span>, h<span class="o">(</span>ours<span class="o">)</span>, or d<span class="o">(</span>ays<span class="o">)</span>
<span class="p">;</span> Default Value: <span class="m">0</span>
<span class="nv">request_slowlog_timeout</span> <span class="o">=</span> 1s
</code></pre></td></tr></table>
</div>
</div><p><a href="https://caihongtengxu.github.io/2019/20190516/index.html">PHP-FPM可以创建慢日志文件，但是却不能给慢日志文件写入内容</a></p>
<h4 id="2-配置php-fpm">2. 配置php-fpm</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ ps -ef <span class="p">|</span> grep php-fpm //可以看到目前有1个Fastcgi进程管理器和2个Fastcgi子进程
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ vim /tmp/php-8.0.0beta3/output/etc/php-fpm.d/www.conf //修改配置文件
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">; The number of child processes created on startup.
; Note: Used only when pm is set to &#39;dynamic&#39;
; Default Value: (min_spare_servers + max_spare_servers) / 2
pm.start_servers = 4

; The desired maximum number of idle server processes.
; Note: Used only when pm is set to &#39;dynamic&#39;
; Note: Mandatory when pm is set to &#39;dynamic&#39;
pm.max_spare_servers = 4
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">kill</span> -USR2 <span class="sb">`</span>cat /tmp/php-8.0.0beta3/output/var/run/php-fpm.pid<span class="sb">`</span> //重启php-fpm

$ ps -ef <span class="p">|</span> grep php-fpm //可以看到目前有1个Fastcgi进程管理器和4个Fastcgi子进程
</code></pre></td></tr></table>
</div>
</div><h4 id="3-php-fpm参数说明httpslearnkucomarticles4483585187d">3. <a href="https://learnku.com/articles/44835#85187d">php-fpm参数说明</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">#php-fpm的运行权限。
#以什么用户什么组的权限来运行池fpm。
user = www
group = www

#php-fpm的运行方式，可以使端口，也可以使socke文件。
#如果是端口则是走tcp，如果是socket则直接读socket文件，这样性能相对更好。
listen = 127.0.0.1:9000 

#拥有socket权限的用户，需要和上面的user、group配置相结合。
#如果采用的端口的方式，则不配置。
listen.owner = www
listen.group = www
listen.mode = 0660

#这是php-fpm端口连接的地址。多个用&#34;,&#34;隔开。默认任意地址都可以连接。
#例如Nginx和php-fpm不在同一台服务器上，这里的值就是Nginx服务的ip地址。
#当Nginx和php-fpm配置在同一台服务器上，则直接写127.0.0.1即可。
listen.allowed_clients = 127.0.0.1 

#pid进程文件存放的位置，当我们启用一个php服务，
#则会自动创建一个该pid文件，其实我们可以直接把该文件理解理解php-fpm的进程号文件，
#两则是等价的。默认为none。
pid = /opt/remi/php72/root/var/run/php-fpm/php-fpm.pid 

#错误日志位置，默认：安装路径 #INSTALL_PREFIX#/log/php-fpm.log。
#如果设置为syslog，log就会发送给syslogd服务而不会写进文件里。
error_log = /opt/remi/php72/root/var/log/php-fpm/error.log 

#PHP限制的文件扩展名
security.limit_extensions = .php .php3 .php4 .php5 .php7

#系统日志标示，如果跑了多个fpm进程，需要用这个来区分日志是谁的。
syslog.ident = php-fpm 

#日记登记，可选：alert, error, warning, notice, debug。
log_level = notice 

#紧急重启阈值，需要与下面emergency_restart_interval参数一起配置。
emergency_restart_threshold = 60 

# 紧急重启阈值的时间范围。在此参数设置的时间内，
# 出现SIGSEGV或SIGBUS的子进程数超过emergency_restart_threshold参数设置的值。
# 那么fpm就会优雅的重启，值是0表示off这个功能，可用的单位有：s秒,m分,h时,d天。
emergency_restart_interval = 60s 

#设置子进程接受主进程复用信号的超时时间。
process_control_timeout = 0 

#当动态管理子进程时，fpm最多能fork多少个进程，0表示无限制，
# 这是所有进程池能启动子进程的总和，谨慎使用。
process.max = 128 

#设置子进程的优先级，在master进程以root用户启动时有效；
#如果没有设置，子进程会继承master进程的优先级，值范围-19(最高)到20(最低)，默认不设置。
process.priority = -19 

#设置成no用于调试bug，默认为yes。
daemonize = yes 

#master进程最多能打开的文件数量。默认采用系统设置的值。
rlimit_files = 1024 

#master进程核心rlimit限制值；可选unlimited或&gt;=0的整数，默认为系统的值。
rlimit_core = 0

#事件处理机制，默认自动检测，可选值：select，poll，
#epoll(linux&gt;=2.5.44)，kqueue，/dev/poll，port
events.mechanism = epoll 

#fpm想系统发送状态的频率。单位有s,m,h。
#前提是fpm被设置会系统服务。
systemd_interval = 10s 
</code></pre></td></tr></table>
</div>
</div><h4 id="4-php-fpm进程进程池配置httpslearnkucomarticles4483585187d">4. <a href="https://learnku.com/articles/44835#85187d">php-fpm进程进程池配置</a></h4>
<blockquote>
<p>1个子进程基本上占用内存在30MB-40MB左右,需要根据自己的主机配置以及业务情况给出合适的方案</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">#php-fpm的队列长度。
listen.backlog = 65535 

#php进程池权限，同样要master进程是root用户才有效，
#和上面的全局设置一样，不设置的话会继承master进程的优先级。
process.priority = -19 

#子进程管理方式
#static(静态配置，在启动php-fpm时根据该值创建固定的子进程数量)；
#dynamic(动态配置，在启动php-fpm时根据pm.start_servers的值初始化对应的子进程数，至少一个子进程)；
#ondemand(按需配置，在启动php-fpm时不创建子进程，而是根据请求动态fork子进程)；
pm = dynamic 

#最大子进程数量
pm.max_children = 5 

#初始化子进程数量，与上面的pm = dynamic配置使用。
pm.start_servers = 2 

#服务器闲置时最少保持2个子进程，不够这个数就会创建，只适用动态dynamic管理方式
pm.min_spare_servers = 2 

#服务器闲置时最多要有几个，多了会kill，只适用动态dynamic管理方式
pm.max_spare_servers = 3 

#子进程闲置时间，也就是说子进程没有可处理的任务时，在该之间使就会被killed。
pm.process_idle_timeout = 10s

#每个子进程最大的处理请求数量。在一定程度上可以防止内存泄漏。
pm.max_requests = 500 

#php-fpm状态监控的uri
pm.status_path string

#php-fpm监控页面的 ping 网址。
#如果没有设置，则无法访问 ping 页面。
#该页面用于外部检测php-fpm是否存活并且可以响应请求。请注意必须以斜线开头（/）。
ping.path string

#用于定义ping请求的返回响应。返回为 HTTP 200 的 text/plain 格式文本。默认值：pong。
ping.response string

#设置worker的nice(2)优先级（如果设置了的话）。
#该值从 -19（最高优先级） 到 20（更低优先级）。 
#默认值：不设置
process.priority int

#检测路径时使用的前缀
prefix string

#访问文件日志，没啥用处，比如yii2每次都记录访问index.php，只是记录真实的PHP文件。
access.log = var/log/$pool.access.log 

#php的慢日志
slowlog = var/log/$pool.log.slow 

#慢日志时间阈值
request_slowlog_timeout = 2s 

#单个请求的超时时间，当php.ini设置的最大执行时间未生效，则交由它来处理。
request_terminate_timeout = 3s 

#最大打开句柄数，默认为系统值。
rlimit_files = 1024 

#最多的核心使用数，默认为系统分配。
rlimit_core = 0 
</code></pre></td></tr></table>
</div>
</div>
  </div>
  <footer>
  <p>
  &copy;  .
  Powered by <a href="https://gohugo.io/">Hugo</a>
  using the <a href="https://github.com/koirand/pulp/">pulp</a> theme.
  </p>
</footer>


  </body>
</html>
