<!DOCTYPE html>
<html>
  <head>
  <title>
      
          Php-fpm 1. Php Fpm 和 Nginx - Mitirrli
      
  </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="" />
  <link rel="shortcut icon" type="image/x-icon" href="/img/">

  
  
  
  
  
  <link rel="stylesheet" href="https://mitirrli.github.io/blog/style.min.6f642c5866835106e8a19b94463576436c99be9e41a8714ab3df3daa95f6bf90.css" integrity="sha256-b2QsWGaDUQbooZuURjV2Q2yZvp5BqHFKs989qpX2v5A=">
  
  
  
  <link rel="stylesheet" href="https://mitirrli.github.io/blog/style-dark.min.0a647fb6c07e04b77b54fa0515d0a683d39ecdb251dba960fe1f966f7ff36fc2.css" media="(prefers-color-scheme: dark)" integrity="sha256-CmR/tsB&#43;BLd7VPoFFdCmg9OezbJR26lg/h&#43;Wb3/zb8I=">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

  
  

  <meta property="og:title" content="Php-fpm 1. Php Fpm 和 Nginx" />
<meta property="og:description" content="nginx 本身不能处理 php,当收到请求后,如果是 php 请求,在本文中,他将请求发送给 fastcgi 管理进程处理,fastcgi 管理进程会选择子进程处理完返回结果给 nginx" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mitirrli.github.io/blog/php/php-fpm/" />
<meta property="article:published_time" content="2020-10-06T12:49:27+08:00" />
<meta property="article:modified_time" content="2020-10-27T17:18:36+08:00" />
<meta itemprop="name" content="Php-fpm 1. Php Fpm 和 Nginx">
<meta itemprop="description" content="nginx 本身不能处理 php,当收到请求后,如果是 php 请求,在本文中,他将请求发送给 fastcgi 管理进程处理,fastcgi 管理进程会选择子进程处理完返回结果给 nginx">
<meta itemprop="datePublished" content="2020-10-06T12:49:27+08:00" />
<meta itemprop="dateModified" content="2020-10-27T17:18:36+08:00" />
<meta itemprop="wordCount" content="407">



<meta itemprop="keywords" content="php-fpm,php,nginx,docker," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:image" content="https://mitirrli.github.io/blog//img/"/>
<meta name="twitter:title" content="Php-fpm 1. Php Fpm 和 Nginx"/>
<meta name="twitter:description" content="nginx 本身不能处理 php,当收到请求后,如果是 php 请求,在本文中,他将请求发送给 fastcgi 管理进程处理,fastcgi 管理进程会选择子进程处理完返回结果给 nginx"/>

  <!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->

  <!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <![endif]-->

  </head>

  <body>
    
  <h1>Php-fpm 1. Php Fpm 和 Nginx</h1>
  <header>
  
  <div class="avatar">
    <img class="avatarMask" src="https://mitirrli.github.io/blog//img/" alt="">
    <a href="https://mitirrli.github.io/blog/"><img class="avatar-border" src="https://mitirrli.github.io/blog//img/avatar-border.svg" alt=""></a>
  </div>
  
  <h2><a class="author" href="https://mitirrli.github.io/blog/"></a></h2>
</header>

  
  
  
  <p class="date">October 6, 2020</p>
  
  
  
  <div id="tags">
    <ul>
      
        
        
          <li><a href="https://mitirrli.github.io/blog/tags/php-fpm/">php-fpm</a></li>
        
      
        
        
          <li><a href="https://mitirrli.github.io/blog/tags/php/">php</a></li>
        
      
        
        
          <li><a href="https://mitirrli.github.io/blog/tags/nginx/">nginx</a></li>
        
      
        
        
          <li><a href="https://mitirrli.github.io/blog/tags/docker/">docker</a></li>
        
      
    </ul>
  </div>
  
  
  <div id="contentBody">
    <blockquote>
<p>nginx 本身不能处理 php,当收到请求后,如果是 php 请求,在本文中,他将请求发送给 fastcgi 管理进程处理,fastcgi 管理进程会选择子进程处理完返回结果给 nginx</p>
</blockquote>
<h2 id="为了不破坏本机的环境搭建一个-ubuntu-的-docker-环境">为了不破坏本机的环境,搭建一个 ubuntu 的 docker 环境</h2>
<h4 id="1-cgi-和-fastcgi">1. CGI 和 FastCGI</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">1. CGI(common gateway interface 公共网关接口)
对于动态的请求，需要用到cgi协议，将请求数据转换成php能理解的信息，然后php根据这些信息返回的信息也要通过cgi协议转换成nginx可以理解的信息，最后nginx接到这些信息再返回给浏览器

2. FastCGI
传统的cgi协议在每次连接请求时，会开启一个进程进行处理，处理完毕会关闭该进程，周而复始。因此有多少个连接就有多少个cgi进程，过多的进程会消耗资源和内存
</code></pre></td></tr></table>
</div>
</div><h4 id="php-cgi">php-cgi</h4>
<blockquote>
<p>php-cgi 是 php 提供给 web serve 的 cgi 协议接口程序</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">当每次接到http前端服务器的请求都会开启一个php-cgi进程进行处理

而且开启的php-cgi的过程中会先要重载配置，数据结构以及初始化运行环境，如果更新了php配置，那么就需要重启php-cgi才能生效

直接杀死php-cgi进程,php就不能运行了(PHP-FPM没有这个问题,守护进程会平滑从新生成新的子进程）
</code></pre></td></tr></table>
</div>
</div><h4 id="php-fpm">php-fpm</h4>
<blockquote>
<p>php-fpm 是 php 提供给 web serve 的 fastcgi 协议接口程序</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">PHP-FPM 允许一个进程对多个连接进行处理，而不会立即关闭这个进程，而是会接着处理下一个连接,它可以说是php-cgi的一个管理程序，是对php-cgi的改进

php-fpm会开启多个php-cgi程序，并且php-fpm常驻内存

每次web serve服务器发送连接过来的时候，php-fpm将连接信息分配给下面其中的一个子程序php-cgi进行处理，处理完毕这个php-cgi并不会关闭，而是继续等待下一个连接，这也是fast-cgi加速的原理

但是由于php-fpm是多进程的，而一个php-cgi基本消耗7-25M内存，因此如果连接过多就会导致内存消耗过大

php-fpm将新的连接发送给新的子程序php-cgi，这个时候加载的是新的配置，而原先正在运行的php-cgi还是使用的原先的配置，等到这个连接后下一次连接的时候会使用新的配置初始化，这就是平滑过渡
</code></pre></td></tr></table>
</div>
</div><h4 id="fastcgi-的工作流程">FastCGI 的工作流程</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">Web Server启动时载入FastCGI进程管理器
FastCGI进程管理器自身初始化，启动多个CGI解释器进程(可见多个php-cgi)并等待来自Web Server的连接
当客户端请求到达Web Server时，FastCGI进程管理器选择并连接到一个CGI解释器。 Web server将CGI环境变量和标准输入发送到FastCGI子进程php-cgi
FastCGI 子进程完成处理后将标准输出和错误信息从同一连接返回Web Server。当FastCGI子进程关闭连接时，请求便告处理完成。FastCGI子进程接着等待并处理来自FastCGI进程管理器(运行在Web Server中)的下一个连接。在CGI模式中，php-cgi在此便退出了
</code></pre></td></tr></table>
</div>
</div><p><a href="https://juejin.im/post/6844903725102792718">参考文章</a></p>
<h4 id="2-编译安装-php">2. 编译安装 php</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ docker pull ubuntu:latest

$ docker run --name ubuntu --cap-add<span class="o">=</span>SYS_PTRACE -p 6767:80 -d ubuntu /bin/bash -c <span class="s2">&#34;while true; do echo 1; sleep 1; done&#34;</span>

$ docker <span class="nb">exec</span> -it ubuntu bash //进入容器

$ <span class="nb">cd</span> /tmp

$ sed -i <span class="s1">&#39;s/archive.ubuntu.com/mirrors.ustc.edu.cn/g&#39;</span> /etc/apt/sources.list //使用国内镜像

$ apt-get update <span class="o">&amp;&amp;</span> apt install -y wget curl vim gcc pkg-config systemctl make libxml2-dev libsqlite3-dev //下载之后需要的一些tool

$ wget -c https://downloads.php.net/~carusogabriel/php-8.0.0beta3.tar.gz //我这边直接安装当前最新版

$ tar zxvf php-8.0.0beta3.tar.gz

$ <span class="nb">cd</span> php-8.0.0beta3

$ ./configure --prefix<span class="o">=</span>/tmp/php-8.0.0beta3/output --enable-fpm --with-fpm-user<span class="o">=</span>www-data --with-fpm-group<span class="o">=</span>www-data //在配置的时候设置路径<span class="o">(</span>安装的路径前缀<span class="o">)</span>,选择开启fpm,同时设置fpm的user和group

$ make //编译,这一步需要比较长的时间<span class="o">(</span>之后sapi/cli目录里就已经有了php的可执行文件<span class="o">)</span>

$ make install //安装<span class="o">(</span>make install后可以执行<span class="nv">$prefix</span>/bin/php,此时在/tmp/php-8.0.0beta3/output/sbin目录下已经有了php-fpm的可执行文件<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="3-重命名配置文件">3. 重命名配置文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ mv /tmp/php-8.0.0beta3/output/etc/php-fpm.conf.default /tmp/php-8.0.0beta3/output/etc/php-fpm.conf <span class="o">&amp;&amp;</span> mv /tmp/php-8.0.0beta3/output/etc/php-fpm.d/www.conf.default /tmp/php-8.0.0beta3/output/etc/php-fpm.d/www.conf
</code></pre></td></tr></table>
</div>
</div><h4 id="4-安装-nginx">4. 安装 nginx</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ apt install -y nginx
</code></pre></td></tr></table>
</div>
</div><h4 id="5-使用-unix-套接字通讯">5. 使用 unix 套接字通讯</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ mkdir -p /var/run/php-fpm

$ vim /tmp/php-8.0.0beta3/output/etc/php-fpm.d/www.conf
// 修改 <span class="nv">listen</span> <span class="o">=</span> /var/run/php-fpm/php8-fpm.sock
// 打开注释 listen.owner <span class="o">=</span> www-data
// 打开注释 listen.group <span class="o">=</span> www-data
// 打开注释 listen.mode <span class="o">=</span> <span class="m">0660</span>

$ vim /tmp/php-8.0.0beta3/output/etc/php-fpm.conf
// 打开注释 <span class="nv">pid</span> <span class="o">=</span> run/php-fpm.pid
// 打开注释 <span class="nv">error_log</span> <span class="o">=</span> log/php-fpm.log

$ /tmp/php-8.0.0beta3/output/sbin/php-fpm -R //启动php-fpm

$ ps -ef <span class="p">|</span> grep php-fpm //这样已经可以看到对应的php-fpm进程了
</code></pre></td></tr></table>
</div>
</div><h4 id="6-创建一个-php-文件">6. 创建一个 php 文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ vim /opt/index.php
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="o">&lt;?</span><span class="nx">php</span>

    <span class="k">echo</span> <span class="nx">phpinfo</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="7-nginx-创建一个配置文件">7. nginx 创建一个配置文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ vim /etc/nginx/conf.d/demo.conf //创建一个配置文件
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
  <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
  <span class="kn">server_name</span> <span class="mi">127</span><span class="s">.0.0.1</span><span class="p">;</span>
  <span class="kn">root</span> <span class="s">/opt</span><span class="p">;</span>

  <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
    <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span> <span class="s">index.php</span><span class="p">;</span>
    <span class="kn">if</span> <span class="s">(!-e</span> <span class="nv">$request_filename</span><span class="s">)</span>
    <span class="p">{</span>
      <span class="kn">rewrite</span> <span class="s">^/(.*)</span>$ <span class="s">/index.php?s=</span><span class="nv">$1</span> <span class="s">last</span><span class="p">;</span>
      <span class="kn">rewrite</span>  <span class="s">index.php/(.*)</span>$ <span class="s">/index.php?s=</span><span class="nv">$1</span> <span class="s">last</span><span class="p">;</span>
      <span class="kn">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
    <span class="kn">fastcgi_pass</span> <span class="s">unix:/var/run/php-fpm/php8-fpm.sock</span><span class="p">;</span>
    <span class="kn">fastcgi_index</span> <span class="s">index.php</span><span class="p">;</span>
    <span class="kn">fastcgi_param</span> <span class="s">SCRIPT_FILENAME</span> <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
    <span class="kn">include</span> <span class="s">fastcgi_params</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ systemctl stop nginx

$ nginx -c /etc/nginx/nginx.conf

$ nginx -s reload //reload会重新加载配置文件
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ curl 127.0.0.1 //在容器中执行本命令可以看到成功结果,容器外访问http://127.0.0.1:6767/可以查看对应详情
</code></pre></td></tr></table>
</div>
</div>
  </div>
  <footer>
  <p>
  &copy;  .
  Powered by <a href="https://gohugo.io/">Hugo</a>
  using the <a href="https://github.com/koirand/pulp/">pulp</a> theme.
  </p>
</footer>


  </body>
</html>
